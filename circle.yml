machine:
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"
  override:
    - docker info
    - if [[ -e ~/docker/postgis.tar ]]; then docker load -i ~/docker/postgis.tar; fi
    - docker pull mdillon/postgis:9.4
    - mkdir -p ~/docker; docker save mdillon/postgis:9.4 > ~/docker/postgis.tar
    - if [[ -e ~/docker/rails.tar ]]; then docker load -i ~/docker/rails.tar; fi
    - docker build -t eiel/parkmap .
    - mkdir -p ~/docker; docker save rails:onbuild > ~/docker/rails.tar
    - bin/docker_push

database:
  override:
    - docker run -d --name my-db mdillon/postgis:9.4; sleep 10
    - docker run -it --link my-db:db -e RAILS_ENV="test" eiel/parkmap rake db:create db:schema:load --trace

test:
  override:
    - bin/ci_test

deployment:
  docker:
    branch: master
    commands:
      - docker push eiel/parkmap
